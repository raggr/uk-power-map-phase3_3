<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UK Government Power Map â€” Constituency Maps</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700;800&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Source Sans 3','Segoe UI',system-ui,sans-serif;background:#f0f2f5;color:#1a1a2e}
  .top-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;flex-wrap:wrap;gap:6px}
  .top-left{display:flex;align-items:center;gap:12px}
  .top-left h1{font-size:16px;font-weight:800;letter-spacing:-0.3px}
  .top-left .sub{font-size:9.5px;color:#5a6577}
  .controls{display:flex;gap:0;flex-wrap:wrap;align-items:center}
  .layer-group{display:flex;gap:0;margin-right:8px;position:relative;margin-top:12px}
  .layer-group-label{font-size:7.5px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#9ca3af;position:absolute;top:-10px;left:4px}
  .map-btn{padding:4px 9px;border:1px solid #d1d5db;font-size:9.5px;font-weight:600;background:#fff;cursor:pointer;color:#555;font-family:inherit;transition:all 0.15s;white-space:nowrap;border-right:none}
  .map-btn:first-of-type{border-radius:5px 0 0 5px}
  .map-btn:last-of-type{border-radius:0 5px 5px 0;border-right:1px solid #d1d5db}
  .map-btn:only-of-type{border-radius:5px;border-right:1px solid #d1d5db}
  .map-btn:hover{background:#f5f6f8}
  .map-btn.active{background:#1a1a2e;color:#fff;border-color:#1a1a2e}
  .back-link{font-size:11px;color:#1d70b8;text-decoration:none;font-weight:600}
  .back-link:hover{text-decoration:underline}
  #map{height:calc(100vh - 58px);width:100%;border-top:1px solid #e2e4e9}
  .legend{background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:10.5px;line-height:1.6;max-width:260px}
  .legend-title{font-weight:700;margin-bottom:4px;font-size:11px}
  .legend-item{display:flex;align-items:flex-start;gap:5px;margin-bottom:1px}
  .legend-swatch{width:14px;height:10px;border-radius:1px;border:1px solid rgba(0,0,0,0.08);flex-shrink:0;margin-top:3px}
  .legend-note{font-size:9px;color:#888;margin-top:4px;border-top:1px solid #eee;padding-top:4px}
  .legend-def{font-size:9px;color:#888;line-height:1.3}
  .info{background:#fff;padding:12px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:11.5px;line-height:1.5;max-width:340px;min-width:220px}
  .info h4{font-size:13px;font-weight:700;margin-bottom:2px;color:#1a1a2e}
  .info .ip-mp{font-weight:600;color:#1a1a2e;margin-top:4px}
  .info .ip-party{color:#5a6577;font-size:10.5px}
  .info .ip-stat{color:#5a6577;font-size:10.5px;margin-top:2px}
  .info .ip-eth{display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;margin-left:3px;vertical-align:middle}
  .info .ip-minister{background:#f0fdf4;border:1px solid #bbf7d0;padding:4px 8px;border-radius:4px;margin-top:5px;font-size:10.5px}
  .info .ip-m-rank{font-weight:700;color:#065f46}
  .info .ip-m-dept{color:#5a6577}
  .info .ip-section{margin-top:6px;padding-top:5px;border-top:1px solid #f0f0f0}
  .info .ip-section-title{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#9ca3af;margin-bottom:2px}
  .info .ip-tag{display:inline-block;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;margin-top:3px}
  .sw-neg{color:#dc2626;font-weight:700} .sw-pos{color:#16a34a;font-weight:700}
  .eth-Asian{background:#dbeafe;color:#1e40af} .eth-Black{background:#ede9fe;color:#5b21b6}
  .eth-Mixed{background:#fce7f3;color:#9d174d} .eth-Other{background:#ecfdf5;color:#065f46}
  .bar{display:flex;height:5px;border-radius:3px;overflow:hidden;margin:3px 0}
  .bar span{display:block;min-width:1px}
  .bw{background:#d1d5db}.ba{background:#3b82f6}.bb{background:#8b5cf6}.bm{background:#ec4899}.bo{background:#10b981}
  .stats-bar{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,0.95);padding:6px 16px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:10.5px;font-weight:600;color:#1a1a2e;white-space:nowrap;pointer-events:none;backdrop-filter:blur(4px);max-width:92vw;overflow:hidden;text-overflow:ellipsis}
  .stats-bar span{color:#5a6577;font-weight:400}
  .biv-wrap{display:flex;align-items:flex-end;gap:6px;margin:6px 0}
  .biv-ylabel{writing-mode:vertical-lr;transform:rotate(180deg);font-size:9px;color:#888;text-align:center}
  .biv-grid{display:grid;grid-template-columns:repeat(3,22px);grid-template-rows:repeat(3,22px);gap:1px}
  .biv-cell{border-radius:2px}
  .biv-xlabel{font-size:9px;color:#888;text-align:center;margin-top:2px}
</style>
</head>
<body>
<div class="top-bar">
  <div class="top-left">
    <a class="back-link" href="../index.html">&larr; Power Map</a>
    <div><h1>UK Constituency Maps</h1><div class="sub">Census 2011/2021 &middot; GE2024 &middot; Notional 2019 &middot; IMD 2019 &middot; 650 constituencies &middot; 16 layers</div></div>
  </div>
  <div class="controls">
    <div class="layer-group">
      <span class="layer-group-label">Demographics</span>
      <button class="map-btn active" onclick="setLayer('diversity')" id="btn-diversity">Diversity</button>
      <button class="map-btn" onclick="setLayer('minority')" id="btn-minority">Minority MPs</button>
      <button class="map-btn" onclick="setLayer('degree')" id="btn-degree">Graduates</button>
      <button class="map-btn" onclick="setLayer('div_change')" id="btn-div_change">Div. Change</button>
      <button class="map-btn" onclick="setLayer('deprivation')" id="btn-deprivation">Deprivation</button>
      <button class="map-btn" onclick="setLayer('gender')" id="btn-gender">Gender</button>
    </div>
    <div class="layer-group">
      <span class="layer-group-label">Brexitland</span>
      <button class="map-btn" onclick="setLayer('brexitland')" id="btn-brexitland">Identity Types</button>
      <button class="map-btn" onclick="setLayer('strongholds')" id="btn-strongholds">Strongholds</button>
      <button class="map-btn" onclick="setLayer('threat')" id="btn-threat">Threat Zones</button>
    </div>
    <div class="layer-group">
      <span class="layer-group-label">Bivariate</span>
      <button class="map-btn" onclick="setLayer('bivariate')" id="btn-bivariate">Edu &times; Reform</button>
      <button class="map-btn" onclick="setLayer('biv_div')" id="btn-biv_div">Div &times; Reform</button>
    </div>
    <div class="layer-group">
      <span class="layer-group-label">Parties &amp; Volatility</span>
      <button class="map-btn" onclick="setLayer('reform_surge')" id="btn-reform_surge">Reform</button>
      <button class="map-btn" onclick="setLayer('realignment')" id="btn-realignment">Realignment</button>
      <button class="map-btn" onclick="setLayer('lab_coalition')" id="btn-lab_coalition">Labour Split</button>
      <button class="map-btn" onclick="setLayer('con_coalition')" id="btn-con_coalition">Con Split</button>
      <button class="map-btn" onclick="setLayer('volatility')" id="btn-volatility">Volatility</button>
    </div>
  </div>
</div>
<div id="map"></div>
<script>
var CL='diversity',geoData,mapData,map,geoLayer,legendCtrl,infoCtrl,statsDiv;
var PE={Lab:{priv:15,oxb:19,uni:90},Con:{priv:46,oxb:29,uni:90},LD:{priv:31,oxb:21,uni:90}};

/* ===== COLOUR FUNCTIONS ===== */
function diversityColor(nw){if(nw>=60)return'#b10026';if(nw>=45)return'#e31a1c';if(nw>=30)return'#fc4e2a';if(nw>=20)return'#fd8d3c';if(nw>=12)return'#feb24c';if(nw>=6)return'#fed976';if(nw>=3)return'#ffeda0';return'#ffffcc'}
function degreeColor(v){if(v==null)return'#f3f4f6';if(v>=50)return'#1e3a8a';if(v>=42)return'#1d4ed8';if(v>=36)return'#2563eb';if(v>=30)return'#60a5fa';if(v>=25)return'#93c5fd';if(v>=20)return'#bfdbfe';return'#eff6ff'}
function reformColor(v){if(v==null||v===0)return'#f3f4f6';if(v>=35)return'#7f1d1d';if(v>=28)return'#991b1b';if(v>=22)return'#dc2626';if(v>=18)return'#ef4444';if(v>=14)return'#f87171';if(v>=10)return'#fca5a5';if(v>=5)return'#fecaca';return'#fef2f2'}

/* Education x Reform bivariate (from colour chart) */
var BIV_ER=[['#3b4994','#8c62aa','#be64ac'],['#5698b9','#a5add3','#dfb0d6'],['#5ac8c8','#ace4e4','#e8e8e8']];
function bivColorER(d,r){if(d==null||r==null)return'#f3f4f6';return BIV_ER[r<10?2:r<22?1:0][d<25?0:d<40?1:2]}

/* Diversity x Reform bivariate */
var BIV_DR=[['#3b4994','#8c62aa','#be64ac'],['#5698b9','#a5add3','#dfb0d6'],['#5ac8c8','#ace4e4','#e8e8e8']];
function bivColorDR(nw,r){if(nw==null||r==null)return'#f3f4f6';return BIV_DR[r<10?2:r<22?1:0][nw<10?0:nw<25?1:2]}

function realignColor(d){if(!d||d.con19==null)return'#e5e7eb';var ch=d.con19>=d.lab19&&d.con19>=(d.ld19||0)&&d.con19>=(d.snp19||0);if(!ch)return'#e5e7eb';if(d.wn==='Lab')return'#e4003b';if(d.wn==='LD')return'#faa61a';if(d.wn==='RUK')return'#12b6cf';if(d.wn==='Green')return'#6ab023';if(d.wn==='Ind')return'#999';if(d.con_sw!=null&&d.con_sw<-25)return'#93c5fd';if(d.con_sw!=null&&d.con_sw<-15)return'#60a5fa';return'#0087dc'}
function brexColor(t){return{cosmo_core:'#2563eb',cosmo_grad:'#60a5fa',necessity:'#f59e0b',id_conservative:'#dc2626',trad_working:'#b45309',mixed:'#d1d5db'}[t]||'#f3f4f6'}
function depColor(p){if(p==null)return'#f3f4f6';if(p>70)return'#7f1d1d';if(p>55)return'#991b1b';if(p>45)return'#dc2626';if(p>35)return'#f87171';if(p>25)return'#fca5a5';if(p>15)return'#86efac';if(p>5)return'#22c55e';return'#15803d'}
function partyColor(p){return{Lab:'#e4003b',Con:'#0087dc',LD:'#faa61a',RUK:'#12b6cf',Green:'#6ab023',SNP:'#fff95d',PC:'#005b54',Ind:'#999',SF:'#326760',DUP:'#d46a4c',APNI:'#f6cb2f',SDLP:'#2aa82c',Spk:'#999',UUP:'#48a5ee',TUV:'#0c3a6a'}[p]||'#999'}
function pcFull(p){if(!p)return'#999';var l=p.toLowerCase();if(~l.indexOf('labour'))return'#e4003b';if(~l.indexOf('conservative'))return'#0087dc';if(~l.indexOf('liberal'))return'#faa61a';if(~l.indexOf('reform'))return'#12b6cf';if(~l.indexOf('green'))return'#6ab023';if(~l.indexOf('snp')||~l.indexOf('scottish'))return'#fff95d';if(~l.indexOf('plaid'))return'#005b54';return'#999'}

/* Diversity change: diverging green-white-red */
function divChangeColor(v){if(v==null)return'#f3f4f6';if(v>=20)return'#7f1d1d';if(v>=15)return'#b91c1c';if(v>=10)return'#ef4444';if(v>=6)return'#fca5a5';if(v>=3)return'#fecaca';if(v>=-1)return'#f5f5f4';if(v>=-5)return'#bbf7d0';return'#22c55e'}

/* Strongholds: diverging blue (liberal) to amber (conservative) */
function strongholdColor(d){if(d.ils==null)return'#f3f4f6';var s=d.ils;if(s>=80)return'#1e3a8a';if(s>=65)return'#2563eb';if(s>=50)return'#60a5fa';if(s>=40)return'#e5e7eb';if(s>=32)return'#fbbf24';if(s>=25)return'#d97706';return'#92400e'}

/* Threat-activation zones */
function threatColor(d){var z=d.ta_zone;if(z==='activated')return'#7f1d1d';if(z==='primed')return'#dc2626';if(z==='latent')return'#fca5a5';return'#f3f4f6'}

/* Labour coalition */
function labCoalColor(d){if(d.wn!=='Lab')return'#f3f4f6';var t=d.lab_type;if(t==='id_liberal')return'#2563eb';if(t==='id_conservative')return'#dc2626';if(t==='contested')return'#f59e0b';return'#e4003b'}

/* Conservative coalition */
function conCoalColor(d){if(d.wn!=='Con')return'#f3f4f6';var t=d.con_type;if(t==='remain_suburban')return'#60a5fa';if(t==='leave_heartland')return'#b91c1c';if(t==='middle')return'#fbbf24';return'#0087dc'}

/* Volatility */
function volColor(v){if(v==null)return'#f3f4f6';if(v>=35)return'#450a0a';if(v>=28)return'#7f1d1d';if(v>=22)return'#991b1b';if(v>=18)return'#dc2626';if(v>=14)return'#ef4444';if(v>=10)return'#f87171';if(v>=5)return'#fca5a5';return'#fef2f2'}

var IDL={cosmo_core:['Cosmopolitan Core','High graduates + high diversity. Urban, professional, Remain-voting.'],cosmo_grad:['Graduate Cosmopolitan','Degree-dense, moderate diversity. University towns, affluent suburbs.'],necessity:['Necessity Liberal','High diversity, fewer graduates. Ethnic minority communities, inner suburbs.'],id_conservative:['Identity Conservative','Very low graduates, high deprivation, very white. Strongest Reform vote.'],trad_working:['Traditional Working Class','Low graduates, low diversity. Ex-industrial, post-mining, Leave heartlands.'],mixed:['Mixed / Transitional','No dominant identity pattern. Suburban, mid-range on most metrics.']};

var LAB_LABELS={id_liberal:'Identity-Liberal Bastion',id_conservative:'Identity-Conservative Heartland',contested:'Contested Middle'};
var CON_LABELS={remain_suburban:'Remain Suburban',leave_heartland:'Leave Heartland',middle:'Middle Ground'};
var THREAT_LABELS={activated:'Activated Zone',primed:'Primed Zone',latent:'Latent Zone'};

/* ===== STYLE ===== */
function getStyle(f){var cd=f.properties.cd,d=mapData?mapData[cd]:null;if(!d)return{fillColor:'#e5e7eb',fillOpacity:0.2,weight:0.3,color:'#bbb',opacity:0.3};var fill='#e5e7eb',op=0.75;
switch(CL){
case'diversity':fill=diversityColor(d.nw);break;
case'minority':if(d.eth){var ec=d.eth==='Asian'?'#3b82f6':d.eth==='Black'?'#8b5cf6':d.eth==='Mixed'?'#ec4899':'#10b981';return{fillColor:ec,fillOpacity:0.7,weight:1.2,color:ec,opacity:0.8}}return{fillColor:'#f3f4f6',fillOpacity:0.15,weight:0.2,color:'#ddd',opacity:0.3};
case'degree':fill=degreeColor(d.deg);break;
case'div_change':fill=divChangeColor(d.div_chg);op=d.div_chg!=null?0.8:0.15;break;
case'bivariate':fill=bivColorER(d.deg,d.ruk);break;
case'biv_div':fill=bivColorDR(d.nw,d.ruk);break;
case'reform_surge':if(d.rns){fill='#f3f4f6';op=0.25}else{fill=reformColor(d.ruk)}break;
case'realignment':fill=realignColor(d);op=d.con19!=null&&d.con19>=d.lab19?0.8:0.2;break;
case'brexitland':if(d.idtype){fill=brexColor(d.idtype)}else{fill='#f3f4f6';op=0.25}break;
case'strongholds':fill=strongholdColor(d);op=d.ils!=null?0.8:0.15;break;
case'threat':fill=threatColor(d);op=d.ta_zone&&d.ta_zone!=='none'?0.85:0.12;break;
case'lab_coalition':fill=labCoalColor(d);op=d.wn==='Lab'?0.8:0.1;break;
case'con_coalition':fill=conCoalColor(d);op=d.wn==='Con'?0.8:0.1;break;
case'volatility':fill=volColor(d.volatility);break;
case'gender':fill=d.gen?(d.gen==='F'?'#db2777':'#2563eb'):'#e5e7eb';op=0.6;break;
case'deprivation':fill=depColor(d.imd_pct);break;
}
return{fillColor:fill,fillOpacity:op,weight:0.5,color:'#666',opacity:0.35}}

function onEachFeature(f,layer){layer.on({mouseover:function(e){e.target.setStyle({weight:2.5,color:'#1a1a2e',opacity:1});e.target.bringToFront();updateInfo(f)},mouseout:function(e){geoLayer.resetStyle(e.target)},click:function(e){map.fitBounds(e.target.getBounds());updateInfo(f)}})}

/* ===== INFO PANEL ===== */
function updateInfo(f){var cd=f.properties.cd,d=mapData?mapData[cd]:null;if(!d){infoCtrl.update('<h4>'+f.properties.nm+'</h4><div class="ip-stat">No data</div>');return}
var h='<h4>'+d.name+'</h4>';
h+='<div class="bar"><span class="bw" style="width:'+d.w+'%"></span><span class="ba" style="width:'+d.a+'%"></span><span class="bb" style="width:'+d.b+'%"></span><span class="bm" style="width:'+d.mx+'%"></span><span class="bo" style="width:'+d.o+'%"></span></div>';
h+='<div class="ip-stat">'+d.nw.toFixed(1)+'% non-White';
if(d.div_chg!=null)h+=' <span style="font-size:9px;color:'+(d.div_chg>0?'#dc2626':'#16a34a')+'">'+(d.div_chg>0?'+':'')+d.div_chg+'pp since 2011</span>';
h+='</div>';
h+='<div class="ip-mp">'+d.mp;if(d.eth)h+=' <span class="ip-eth eth-'+d.eth+'">'+d.eth+'</span>';if(d.gen)h+=' <span style="font-size:10px;color:#888">'+(d.gen==='F'?'\u2640':'\u2642')+'</span>';h+='</div>';
h+='<div class="ip-party" style="border-left:3px solid '+pcFull(d.party)+';padding-left:6px">'+d.party+'</div>';
if(d.minister)h+='<div class="ip-minister"><span class="ip-m-rank">'+d.minister.rank+'</span> \u00b7 <span class="ip-m-dept">'+d.minister.dept+'</span></div>';

/* Tags row */
var tags='';
if(d.idtype&&IDL[d.idtype]){var tc=brexColor(d.idtype);tags+='<span class="ip-tag" style="background:'+tc+'18;color:'+tc+';border:1px solid '+tc+'44">'+IDL[d.idtype][0]+'</span> '}
if(d.ta_zone&&d.ta_zone!=='none'){tags+='<span class="ip-tag" style="background:#dc262618;color:#dc2626;border:1px solid #dc262644">\u26a0 '+THREAT_LABELS[d.ta_zone]+'</span> '}
if(CL==='lab_coalition'&&d.lab_type){var ltc=d.lab_type==='id_liberal'?'#2563eb':d.lab_type==='id_conservative'?'#dc2626':'#f59e0b';tags+='<span class="ip-tag" style="background:'+ltc+'18;color:'+ltc+';border:1px solid '+ltc+'44">'+LAB_LABELS[d.lab_type]+'</span> '}
if(CL==='con_coalition'&&d.con_type){var ctc=d.con_type==='remain_suburban'?'#60a5fa':d.con_type==='leave_heartland'?'#b91c1c':'#fbbf24';tags+='<span class="ip-tag" style="background:'+ctc+'18;color:'+ctc+';border:1px solid '+ctc+'44">'+CON_LABELS[d.con_type]+'</span> '}
if(tags)h+='<div style="margin-top:3px">'+tags+'</div>';

/* Education */
if(d.deg!=null){h+='<div class="ip-section"><div class="ip-section-title">Education (Census)</div><div class="ip-stat">Graduates: <b>'+d.deg+'%</b>';if(d.nq!=null)h+=' \u00b7 No qualifications: '+d.nq+'%';h+='</div>';
h+='<div style="height:5px;border-radius:3px;background:#e5e7eb;margin:3px 0"><div style="height:100%;border-radius:3px;width:'+Math.min(100,d.deg*1.5)+'%;background:linear-gradient(90deg,#60a5fa,#2563eb)"></div></div>';
var pk=d.wn==='Lab'?'Lab':d.wn==='Con'?'Con':d.wn==='LD'?'LD':null;if(pk&&PE[pk]){var gap=PE[pk].uni-d.deg;h+='<div class="ip-stat" style="color:#9ca3af">'+pk+' MPs: '+PE[pk].uni+'% uni vs '+d.deg+'% local grads (gap +'+gap.toFixed(0)+'pp)</div>'}h+='</div>'}

/* Identity scores on strongholds layer */
if(CL==='strongholds'&&d.ils!=null){h+='<div class="ip-section"><div class="ip-section-title">Identity Scores</div><div class="ip-stat">Liberal (grad+diversity): <b>'+d.ils.toFixed(0)+'</b></div>';if(d.ics!=null)h+='<div class="ip-stat">Conservative (noQual+white): <b>'+d.ics.toFixed(0)+'</b></div>';h+='</div>'}

/* Election */
h+='<div class="ip-section"><div class="ip-section-title">2024 Election</div><div class="ip-stat">Reform: <b>'+d.ruk+'%</b>';if(d.rns)h+=' <span style="color:#dc2626;font-size:9px">(didn\u2019t stand)</span>';h+='</div>';
if(d.wn)h+='<div class="ip-stat">Winner: <span style="color:'+partyColor(d.wn)+';font-weight:700">'+d.wn+'</span> \u00b7 Maj: '+d.mj+'%</div>';h+='</div>';

/* Swings */
if(d.con_sw!=null||d.lab_sw!=null){h+='<div class="ip-section"><div class="ip-section-title">Swing vs 2019</div>';
if(d.con_sw!=null)h+='<div class="ip-stat">Con: <span class="'+(d.con_sw<0?'sw-neg':'sw-pos')+'">'+(d.con_sw>0?'+':'')+d.con_sw+'pp</span></div>';
if(d.lab_sw!=null)h+='<div class="ip-stat">Lab: <span class="'+(d.lab_sw>0?'sw-pos':'sw-neg')+'">'+(d.lab_sw>0?'+':'')+d.lab_sw+'pp</span></div>';
if(d.ruk_sw!=null)h+='<div class="ip-stat">Reform: <span class="sw-pos">+'+d.ruk_sw+'pp</span></div>';
if(d.volatility!=null)h+='<div class="ip-stat" style="font-weight:600;color:#1a1a2e">Volatility: '+d.volatility+'pp</div>';
h+='</div>'}

/* Leave */
if(d.lv!==undefined&&d.lv!==''&&d.lv!==null)h+='<div class="ip-section"><div class="ip-section-title">EU Referendum (est.)</div><div class="ip-stat">Leave: <b>'+Number(d.lv).toFixed(1)+'%</b> \u00b7 Remain: '+(100-d.lv).toFixed(1)+'%</div></div>';

/* Deprivation */
if(d.imd_score!=null){var dd=d.imd_q<=2?'High deprivation':d.imd_q<=3?'Medium':d.imd_q<=4?'Below average':'Low deprivation';h+='<div class="ip-section"><div class="ip-section-title">Deprivation</div><div class="ip-stat">IMD: '+d.imd_score+' (Q'+d.imd_q+', '+dd+')</div>';
if(d.high_dep!=null&&d.high_dep>0)h+='<div class="ip-stat">'+d.high_dep+'% in high-deprivation areas</div>';
h+='</div>'}else if(d.imd_pct!=null){var dd=d.imd_pct>70?'Very high':d.imd_pct>50?'Above average':d.imd_pct>30?'Below average':'Low';h+='<div class="ip-section"><div class="ip-section-title">Deprivation</div><div class="ip-stat">'+d.imd_pct+'/100 ('+dd+')</div></div>'}

infoCtrl.update(h)}

/* ===== LEGEND ===== */
function mkLeg(items,note){return items.map(function(x){return'<div class="legend-item"><div class="legend-swatch" style="background:'+x[0]+'"></div>'+(x[2]?'<div>'+x[1]+'<br><span class="legend-def">'+x[2]+'</span></div>':x[1])+'</div>'}).join('')+(note?'<div class="legend-note">'+note+'</div>':'')}

function getLegendHTML(){
if(CL==='diversity')return'<div class="legend-title">% Non-White Population</div>'+mkLeg([['#ffffcc','0\u20133%'],['#ffeda0','3\u20136%'],['#fed976','6\u201312%'],['#feb24c','12\u201320%'],['#fd8d3c','20\u201330%'],['#fc4e2a','30\u201345%'],['#e31a1c','45\u201360%'],['#b10026','60%+']],'Census 2021 (E&amp;W, NI) / 2022 (Scotland)');
if(CL==='minority')return'<div class="legend-title">Ethnic Minority MPs (87 of 650)</div>'+mkLeg([['#3b82f6','Asian (51)'],['#8b5cf6','Black (15)'],['#ec4899','Mixed (20)'],['#10b981','Other (1)'],['#f3f4f6','Not minority']]);
if(CL==='degree')return'<div class="legend-title">% with Degree (Level 4+)</div>'+mkLeg([['#eff6ff','15\u201320%'],['#bfdbfe','20\u201325%'],['#93c5fd','25\u201330%'],['#60a5fa','30\u201336%'],['#2563eb','36\u201342%'],['#1d4ed8','42\u201350%'],['#1e3a8a','50\u201366%']],'Census 2021 TS067 (E&amp;W).<br>Strongest predictor of Leave (r=\u22120.86).');
if(CL==='div_change')return'<div class="legend-title">Diversity Change 2011 \u2192 2021</div>'+mkLeg([['#22c55e','Decrease (\u22645pp)'],['#bbf7d0','Small decrease'],['#f5f5f4','Stable (\u00b11pp)'],['#fecaca','Small increase (+3\u20136pp)'],['#fca5a5','Moderate (+6\u201310pp)'],['#ef4444','Large (+10\u201315pp)'],['#b91c1c','Very large (+15\u201320pp)'],['#7f1d1d','Extreme (+20pp+)']],'Change in non-white %. E&amp;W only (542/650).<br>2011 PCON mapped to 2024 boundaries.');
if(CL==='bivariate'){var h='<div class="legend-title">Education \u00d7 Reform Vote</div><div class="biv-wrap"><div class="biv-ylabel">\u2191 Reform %</div><div><div class="biv-grid">';BIV_ER.flat().forEach(function(c){h+='<div class="biv-cell" style="background:'+c+'"></div>'});return h+'</div><div class="biv-xlabel">Graduate % \u2192</div></div></div><div class="legend-note">\u2196 Identity conservative heartland<br>\u2198 Cosmopolitan heartland</div>'}
if(CL==='biv_div'){var h='<div class="legend-title">Diversity \u00d7 Reform Vote</div><div class="biv-wrap"><div class="biv-ylabel">\u2191 Reform %</div><div><div class="biv-grid">';BIV_DR.flat().forEach(function(c){h+='<div class="biv-cell" style="background:'+c+'"></div>'});return h+'</div><div class="biv-xlabel">Non-White % \u2192</div></div></div><div class="legend-note">\u2196 White + high Reform (nativist pressure)<br>\u2198 Diverse + low Reform (cosmopolitan)</div>'}
if(CL==='reform_surge')return'<div class="legend-title">Reform UK 2024 Vote Share</div>'+mkLeg([['#fef2f2','0\u20135%'],['#fecaca','5\u201310%'],['#fca5a5','10\u201314%'],['#f87171','14\u201318%'],['#ef4444','18\u201322%'],['#dc2626','22\u201328%'],['#991b1b','28\u201335%'],['#7f1d1d','35%+']],'Grey = did not stand (23 GB + 18 NI).<br>5 seats won. Peak: Clacton 46.2%.');
if(CL==='realignment')return'<div class="legend-title">2024 Party Realignment</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">Where the 2019 Conservative coalition went</div>'+mkLeg([['#e4003b','Con \u2192 Labour','Red Wall collapse'],['#faa61a','Con \u2192 Lib Dem','Blue Wall revolt'],['#12b6cf','Con \u2192 Reform','Right-flank defection'],['#60a5fa','Con held (wounded)','Lost 15\u201325pp'],['#93c5fd','Con held (gutted)','Lost 25pp+'],['#0087dc','Con held','Smaller swing'],['#e5e7eb','Not Con in 2019','']],'Notional 2019 (Rallings &amp; Thrasher)');
if(CL==='brexitland'){var h='<div class="legend-title">Brexitland Identity Types</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">After Sobolewska &amp; Ford (2020)</div>';['cosmo_core','cosmo_grad','necessity','id_conservative','trad_working','mixed'].forEach(function(k){var l=IDL[k];h+='<div class="legend-item"><div class="legend-swatch" style="background:'+brexColor(k)+'"></div><div>'+l[0]+'<br><span class="legend-def">'+l[1]+'</span></div></div>'});return h+'<div class="legend-note">631/650 coverage (excl. NI).</div>'}
if(CL==='strongholds')return'<div class="legend-title">Identity Strongholds</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">Score = % graduates + % non-white</div>'+mkLeg([['#1e3a8a','Strong liberal (\u226580)'],['#2563eb','Liberal (65\u201380)'],['#60a5fa','Leaning liberal (50\u201365)'],['#e5e7eb','Mixed / neutral (40\u201350)'],['#fbbf24','Leaning conservative (32\u201340)'],['#d97706','Conservative (25\u201332)'],['#92400e','Strong conservative (<25)']],'Blue = conviction/necessity liberal heartlands.<br>Amber = identity-conservative strongholds.');
if(CL==='threat')return'<div class="legend-title">Threat-Activation Zones</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">Stenner/Brexitland: threat activates ethnocentrism</div>'+mkLeg([['#7f1d1d','Activated','IC structure + threat + Reform voting'],['#dc2626','Primed','IC structure + diversity change/deprivation'],['#fca5a5','Latent','IC structure, low perceived threat'],['#f3f4f6','Not identity-conservative','']],'IC structure = low graduates, low diversity,<br>high no-qualifications.');
if(CL==='lab_coalition')return'<div class="legend-title">Labour\u2019s Two Geographies</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">Brexitland: Labour\u2019s past vs future</div>'+mkLeg([['#2563eb','Identity-Liberal Bastion','Low Leave, diverse, cosmopolitan'],['#f59e0b','Contested Middle','Mixed, cross-pressured'],['#dc2626','Identity-Conservative Heartland','High Leave, white, Reform risk'],['#f3f4f6','Non-Labour seat','']],'Labour holds 410 seats across<br>fundamentally different communities.');
if(CL==='con_coalition')return'<div class="legend-title">Conservative Coalition Tensions</div><div style="font-size:9.5px;color:#666;margin-bottom:4px">Squeezed between Lib Dems and Reform</div>'+mkLeg([['#60a5fa','Remain Suburban','Graduates, low Leave. LD vulnerable.'],['#fbbf24','Middle Ground','Traditional Tory territory.'],['#b91c1c','Leave Heartland','High Leave, very white. Reform threat.'],['#f3f4f6','Non-Conservative seat','']],'121 Conservative seats remain.');
if(CL==='volatility')return'<div class="legend-title">Electoral Volatility (2019\u21922024)</div>'+mkLeg([['#fef2f2','Low (<5pp)'],['#fca5a5','Moderate (5\u201310pp)'],['#f87171','Significant (10\u201314pp)'],['#ef4444','High (14\u201318pp)'],['#dc2626','Very high (18\u201322pp)'],['#991b1b','Extreme (22\u201328pp)'],['#7f1d1d','Seismic (28\u201335pp)'],['#450a0a','Unprecedented (35pp+)']],'Max absolute swing among Con/Lab/Reform.<br>Notional 2019 \u2192 actual 2024.');
if(CL==='gender')return'<div class="legend-title">MP Gender</div>'+mkLeg([['#db2777','Female'],['#2563eb','Male']],'Cosmo core: 55% female MPs.<br>Id-conservative: 19% female.');
if(CL==='deprivation')return'<div class="legend-title">Deprivation (UK-harmonised)</div>'+mkLeg([['#15803d','Low'],['#22c55e','Below avg'],['#86efac','Slightly below'],['#fca5a5','Above avg'],['#f87171','High'],['#dc2626','Very high'],['#991b1b','Severe'],['#7f1d1d','Extreme']],'UK IMD 2019 (Abel, Payne &amp; Barclay).<br>649/650 coverage.');
return''}

/* ===== STATS BAR ===== */
function updateStats(){
if(!mapData||!statsDiv)return;var vals=Object.values(mapData),n=vals.length;
if(CL==='diversity'){var avg=vals.reduce(function(s,v){return s+v.nw},0)/n;statsDiv.innerHTML='Mean: <span>'+avg.toFixed(1)+'% non-White</span> \u00b7 Range: <span>1.1%\u201379.9%</span> \u00b7 UK overall: <span>18.3%</span>'}
else if(CL==='minority'){var mn=vals.filter(function(v){return v.eth}).length;statsDiv.innerHTML=mn+' minority MPs <span>of '+n+' ('+((mn/n)*100).toFixed(1)+'%)</span> \u00b7 UK non-White: <span>18.3%</span>'}
else if(CL==='degree'){var dv=vals.filter(function(v){return v.deg!=null}),avg=dv.reduce(function(s,v){return s+v.deg},0)/dv.length;statsDiv.innerHTML='Mean: <span>'+avg.toFixed(1)+'% graduates</span> \u00b7 Range: <span>17.5%\u201365.6%</span> \u00b7 Degree vs Leave: <span>r = \u22120.86</span>'}
else if(CL==='div_change'){var dc=vals.filter(function(v){return v.div_chg!=null}),avg=dc.reduce(function(s,v){return s+v.div_chg},0)/dc.length,big=dc.filter(function(v){return v.div_chg>=10}).length;statsDiv.innerHTML='Mean change: <span>+'+avg.toFixed(1)+'pp</span> \u00b7 '+big+' seats with \u226510pp increase \u00b7 <span>542/650 coverage (E&amp;W)</span>'}
else if(CL==='bivariate'){statsDiv.innerHTML='Education is <span>the strongest predictor</span> of Leave/Reform voting (r = \u22120.86) \u2014 <span>twice as strong as ethnic diversity</span> (r = \u22120.41)'}
else if(CL==='biv_div'){statsDiv.innerHTML='Diversity \u00d7 Reform: <span>nativist pressure</span> (top-left) = white + high Reform \u00b7 <span>cosmopolitan</span> (bottom-right) = diverse + low Reform'}
else if(CL==='reform_surge'){var rv=vals.filter(function(v){return v.ruk>0&&!v.rns}),avg=rv.reduce(function(s,v){return s+v.ruk},0)/rv.length,high=rv.filter(function(v){return v.ruk>=20}).length;statsDiv.innerHTML='Mean Reform: <span>'+avg.toFixed(1)+'%</span> \u00b7 '+high+' seats above 20% \u00b7 <span>5 seats won</span> \u00b7 Peak: <span>Clacton 46.2%</span>'}
else if(CL==='realignment'){var lost=vals.filter(function(v){return v.con19!=null&&v.con19>=v.lab19&&v.con19>=(v.ld19||0)&&v.wn!=='Con'}).length;statsDiv.innerHTML='Notional Con seats lost: <span>~'+lost+'</span> \u00b7 Collapsed on both flanks: Red Wall to Lab, Blue Wall to LD, right to Reform'}
else if(CL==='brexitland'){var tc={};vals.forEach(function(v){if(v.idtype){tc[v.idtype]=(tc[v.idtype]||0)+1}});statsDiv.innerHTML='<span style="color:#2563eb">\u25cf</span> Core: '+(tc.cosmo_core||0)+' \u00b7 <span style="color:#60a5fa">\u25cf</span> Grad: '+(tc.cosmo_grad||0)+' \u00b7 <span style="color:#f59e0b">\u25cf</span> Necess: '+(tc.necessity||0)+' \u00b7 <span style="color:#dc2626">\u25cf</span> Id-con: '+(tc.id_conservative||0)+' \u00b7 <span style="color:#b45309">\u25cf</span> Trad: '+(tc.trad_working||0)+' \u00b7 Mixed: '+(tc.mixed||0)}
else if(CL==='strongholds'){var lib=vals.filter(function(v){return v.ils!=null&&v.ils>=50}).length,con=vals.filter(function(v){return v.ils!=null&&v.ils<32}).length;statsDiv.innerHTML='Identity-liberal strongholds (\u226550): <span>'+lib+'</span> \u00b7 Identity-conservative strongholds (<32): <span>'+con+'</span> \u00b7 Score = <span>% grads + % non-white</span>'}
else if(CL==='threat'){var ac=vals.filter(function(v){return v.ta_zone==='activated'}).length,pr=vals.filter(function(v){return v.ta_zone==='primed'}).length,la=vals.filter(function(v){return v.ta_zone==='latent'}).length;statsDiv.innerHTML='Activated: <span>'+ac+'</span> \u00b7 Primed: <span>'+pr+'</span> \u00b7 Latent: <span>'+la+'</span> \u00b7 Volatility clusters where identity conservatives perceive threat'}
else if(CL==='lab_coalition'){var il=vals.filter(function(v){return v.lab_type==='id_liberal'}).length,ic=vals.filter(function(v){return v.lab_type==='id_conservative'}).length,ct=vals.filter(function(v){return v.lab_type==='contested'}).length;statsDiv.innerHTML='Labour: <span>'+il+' identity-liberal</span> \u00b7 <span>'+ic+' identity-conservative</span> \u00b7 <span>'+ct+' contested</span> \u2014 the party must bridge these divides'}
else if(CL==='con_coalition'){var rs=vals.filter(function(v){return v.con_type==='remain_suburban'}).length,lh=vals.filter(function(v){return v.con_type==='leave_heartland'}).length,md=vals.filter(function(v){return v.con_type==='middle'}).length;statsDiv.innerHTML='Conservative: <span>'+rs+' Remain suburban</span> \u00b7 <span>'+lh+' Leave heartland</span> \u00b7 <span>'+md+' middle</span> \u2014 squeezed between LD and Reform'}
else if(CL==='volatility'){var vv=vals.filter(function(v){return v.volatility!=null}),avg=vv.reduce(function(s,v){return s+v.volatility},0)/vv.length,extreme=vv.filter(function(v){return v.volatility>=25}).length;statsDiv.innerHTML='Mean volatility: <span>'+avg.toFixed(1)+'pp</span> \u00b7 '+extreme+' seats with extreme swing (\u226525pp) \u00b7 <span>Largest recorded party system upheaval</span>'}
else if(CL==='gender'){var f=vals.filter(function(v){return v.gen==='F'}).length;statsDiv.innerHTML='Female: <span>'+f+' ('+((f/n)*100).toFixed(0)+'%)</span> \u00b7 Male: <span>'+(n-f)+'</span> \u00b7 Cosmo core: <span>55% \u2640</span> \u00b7 Id-conservative: <span>19% \u2640</span>'}
else if(CL==='deprivation'){statsDiv.innerHTML='UK-harmonised IMD 2019 \u00b7 <span>All 4 nations comparable</span> \u00b7 Coverage: <span>649/650</span>'}
}

/* ===== LAYER SWITCH ===== */
function setLayer(name){
CL=name;
document.querySelectorAll('.map-btn').forEach(function(b){b.classList.remove('active')});
document.getElementById('btn-'+name).classList.add('active');
if(geoLayer)geoLayer.setStyle(getStyle);
if(legendCtrl)legendCtrl.update();
updateStats();
}

/* ===== INIT ===== */
function initMap(){
map=L.map('map',{zoomControl:true}).setView([54.5,-3.5],6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{attribution:'\u00a9 OpenStreetMap \u00a9 CARTO',maxZoom:18}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{maxZoom:18,pane:'overlayPane'}).addTo(map);
infoCtrl=L.control({position:'topright'});
infoCtrl.onAdd=function(){this._div=L.DomUtil.create('div','info');this._div.innerHTML='<h4>Hover over a constituency</h4><div class="ip-stat">650 constituencies \u00b7 16 analytical layers</div><div class="ip-stat" style="margin-top:4px">Census 2011/2021 \u00b7 GE2024 \u00b7 Notional 2019 \u00b7 IMD 2019</div>';return this._div};
infoCtrl.update=function(html){this._div.innerHTML=html};
infoCtrl.addTo(map);
legendCtrl=L.control({position:'bottomleft'});
legendCtrl.onAdd=function(){this._div=L.DomUtil.create('div','legend');this.update();return this._div};
legendCtrl.update=function(){this._div.innerHTML=getLegendHTML()};
legendCtrl.addTo(map);
statsDiv=document.createElement('div');statsDiv.className='stats-bar';document.getElementById('map').appendChild(statsDiv);
Promise.all([
fetch('../assets/constituencies.geojson').then(function(r){return r.json()}),
fetch('../assets/map-data.json').then(function(r){return r.json()})
]).then(function(results){
geoData=results[0];mapData=results[1];
geoLayer=L.geoJSON(geoData,{style:getStyle,onEachFeature:onEachFeature}).addTo(map);
updateStats();
}).catch(function(err){
document.getElementById('map').innerHTML='<div style="text-align:center;padding:60px 20px;color:#991b1b"><h3>Failed to load map data</h3><p>'+err.message+'</p><p style="color:#5a6577;font-size:12px">Serve locally: <code>python3 -m http.server</code></p></div>';
});
}
initMap();
</script>
</body>
</html>
